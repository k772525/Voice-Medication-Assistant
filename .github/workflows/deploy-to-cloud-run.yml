# GitHub Actions Workflow for deploying to Google Cloud Run
# æ­¤å·¥ä½œæµç¨‹ä½¿ç”¨ Workload Identity Federation é€²è¡Œå®‰å…¨èº«ä»½é©—è­‰
name: Deploy to Cloud Run

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è‡ªå‹•åŸ·è¡Œéƒ¨ç½²
on:
  push:
    branches:
      - main
  # å¯é¸ï¼šæ”¯æ´æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:

# è¨­ç½®ç’°å¢ƒè®Šæ•¸ï¼Œä¾¿æ–¼çµ±ä¸€ç®¡ç†é…ç½®è³‡è¨Š
env:
  PROJECT_ID: gcp1-462701                                  # GCP å°ˆæ¡ˆ ID
  SERVICE_NAME: linebot0831                                # Cloud Run æœå‹™åç¨±
  REGION: us-central1                                      # éƒ¨ç½²å€åŸŸ
  REPOSITORY: linebot-repo                                 # Artifact Registry å€‰åº«åç¨±
  IMAGE_NAME: linebot0831                                  # Docker æ˜ åƒæª”åç¨±

jobs:
  deploy:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu é‹è¡Œç’°å¢ƒ
    runs-on: ubuntu-latest
    
    # é…ç½®æ¬Šé™ï¼Œç¢ºä¿ GITHUB_TOKEN å…·æœ‰å¿…è¦çš„æ¬Šé™
    permissions:
      contents: read
      id-token: write  # é€™å€‹æ¬Šé™å°æ–¼ Workload Identity Federation æ˜¯å¿…éœ€çš„

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡ºç¨‹å¼ç¢¼åº«
      # ç²å–å€‰åº«çš„åŸå§‹ç¢¼åˆ°å·¥ä½œæµé‹è¡Œç’°å¢ƒä¸­
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: é…ç½® Google Cloud èº«ä»½é©—è­‰
      # ä½¿ç”¨æœå‹™å¸³è™Ÿé‡‘é‘°é€²è¡Œèº«ä»½é©—è­‰
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          # æœå‹™å¸³è™Ÿ JSON é‡‘é‘°
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # åŒ¯å‡º Google Cloud SDK æ†‘æ“šä»¥ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          export_environment_variables: true

      # æ­¥é©Ÿ 3: è¨­ç½® Google Cloud SDK
      # å®‰è£ä¸¦é…ç½® gcloud CLI å·¥å…·
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      # æ­¥é©Ÿ 4: é©—è­‰èº«ä»½é©—è­‰ç‹€æ…‹
      # ç¢ºèª gcloud å·²æ­£ç¢ºé…ç½®ä¸¦å¯ä»¥å­˜å– GCP å°ˆæ¡ˆ
      - name: Verify authentication
        run: |
          echo "é©—è­‰ GCP èº«ä»½é©—è­‰ç‹€æ…‹..."
          gcloud auth list
          gcloud config list project

      # æ­¥é©Ÿ 5: é…ç½® Docker èªè­‰
      # é…ç½® Docker ä»¥ä½¿ç”¨ gcloud ä½œç‚º Artifact Registry çš„æ†‘æ“šåŠ©æ‰‹
      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # æ­¥é©Ÿ 6: å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒæª”åˆ° Artifact Registry
      # ä½¿ç”¨å°ˆæ¡ˆä¸­çš„ Dockerfile å»ºç½®æ˜ åƒæª”ä¸¦æ¨é€åˆ° Artifact Registry
      - name: Build and push Docker image
        run: |
          # è¨­ç½®å®Œæ•´çš„æ˜ åƒæª”æ¨™ç±¤
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          
          # å»ºç½® Docker æ˜ åƒæª”ï¼Œä½¿ç”¨ commit SHA å’Œ latest æ¨™ç±¤
          echo "å»ºç½® Docker æ˜ åƒæª”..."
          docker build -t ${IMAGE_TAG}:${{ github.sha }} .
          docker build -t ${IMAGE_TAG}:latest .
          
          # æ¨é€æ˜ åƒæª”åˆ° Artifact Registry
          echo "æ¨é€æ˜ åƒæª”åˆ° Artifact Registry..."
          docker push ${IMAGE_TAG}:${{ github.sha }}
          docker push ${IMAGE_TAG}:latest

      # æ­¥é©Ÿ 7: éƒ¨ç½²åˆ° Cloud Run
      # ä½¿ç”¨å®˜æ–¹çš„ Google GitHub Action éƒ¨ç½²æœå‹™åˆ° Cloud Run
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          # Cloud Run æœå‹™åç¨±
          service: ${{ env.SERVICE_NAME }}
          # éƒ¨ç½²å€åŸŸ
          region: ${{ env.REGION }}
          # è¦éƒ¨ç½²çš„ Docker æ˜ åƒæª”ï¼Œä½¿ç”¨ latest æ¨™ç±¤
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          # è¨­ç½®æœå‹™çš„æ¨™ç±¤ï¼Œä¾¿æ–¼ç®¡ç†å’Œè¿½è¹¤
          labels: |
            environment=production
            deployed-by=github-actions
            commit-sha=${{ github.sha }}
          # ç’°å¢ƒè®Šæ•¸é…ç½® - åŒ…å«æ‡‰ç”¨ç¨‹å¼æ‰€éœ€çš„æ‰€æœ‰ç’°å¢ƒè®Šæ•¸
          env_vars: |
            ENV=production
            VERSION=${{ github.sha }}
            LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
            LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}
            YOUR_BOT_ID=${{ secrets.YOUR_BOT_ID }}
            LINE_LOGIN_CHANNEL_ID=${{ secrets.LINE_LOGIN_CHANNEL_ID }}
            LINE_LOGIN_CHANNEL_SECRET=${{ secrets.LINE_LOGIN_CHANNEL_SECRET }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            LIFF_CHANNEL_ID=${{ secrets.LIFF_CHANNEL_ID }}
            LIFF_ID_CAMERA=${{ secrets.LIFF_ID_CAMERA }}
            LIFF_ID_EDIT=${{ secrets.LIFF_ID_EDIT }}
            LIFF_ID_PRESCRIPTION_REMINDER=${{ secrets.LIFF_ID_PRESCRIPTION_REMINDER }}
            LIFF_ID_MANUAL_REMINDER=${{ secrets.LIFF_ID_MANUAL_REMINDER }}
            LIFF_ID_HEALTH_FORM=${{ secrets.LIFF_ID_HEALTH_FORM }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}
            SPEECH_TO_TEXT_ENABLED=${{ secrets.SPEECH_TO_TEXT_ENABLED }}
            SPEECH_LANGUAGE_CODE=${{ secrets.SPEECH_LANGUAGE_CODE }}
            YOLO_V12_URL=${{ secrets.YOLO_V12_URL }}
            YOLO_V11_URL=${{ secrets.YOLO_V11_URL }}
            KEVIN_API_URL=${{ secrets.KEVIN_API_URL }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_PORT=${{ secrets.DB_PORT }}
            REMINDER_SECRET_TOKEN=${{ secrets.REMINDER_SECRET_TOKEN }}
          # Cloud Run æœå‹™é…ç½®
          timeout: 300            # è«‹æ±‚é€¾æ™‚æ™‚é–“ï¼ˆç§’ï¼‰
          # å…è¨±æœªç¶“èº«ä»½é©—è­‰çš„è«‹æ±‚ï¼ˆæ ¹æ“šæ‚¨çš„å®‰å…¨éœ€æ±‚èª¿æ•´ï¼‰
          flags: --allow-unauthenticated --memory=1Gi --cpu=1 --max-instances=100 --min-instances=0 --concurrency=80

      # æ­¥é©Ÿ 9: è¨­ç½® Cloud Scheduler
      # è‡ªå‹•è¨­ç½®ç”¨è—¥æé†’çš„æ’ç¨‹ä»»å‹™
      - name: Setup Cloud Scheduler
        run: |
          echo "è¨­ç½® Cloud Scheduler..."
          
          # å•Ÿç”¨ Cloud Scheduler API
          gcloud services enable cloudscheduler.googleapis.com
          
          # æª¢æŸ¥æ˜¯å¦éœ€è¦å‰µå»º App Engine æ‡‰ç”¨ï¼ˆCloud Scheduler éœ€è¦ï¼‰
          if ! gcloud app describe &>/dev/null; then
            echo "å‰µå»º App Engine æ‡‰ç”¨..."
            gcloud app create --region=us-central1
          else
            echo "App Engine æ‡‰ç”¨å·²å­˜åœ¨"
          fi
          
          # ç²å–éƒ¨ç½²çš„æœå‹™ URL
          SERVICE_URL="${{ steps.deploy.outputs.url }}"
          
          # åˆªé™¤èˆŠçš„æ’ç¨‹ä»»å‹™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if gcloud scheduler jobs describe reminder-check-job --location=us-central1 &>/dev/null; then
            echo "åˆªé™¤èˆŠçš„æ’ç¨‹ä»»å‹™..."
            gcloud scheduler jobs delete reminder-check-job --location=us-central1 --quiet
          fi
          
          # å‰µå»ºæ–°çš„æ’ç¨‹ä»»å‹™
          echo "å‰µå»ºç”¨è—¥æé†’æ’ç¨‹ä»»å‹™..."
          gcloud scheduler jobs create http reminder-check-job \
            --location=us-central1 \
            --schedule="* * * * *" \
            --uri="${SERVICE_URL}/api/check-reminders" \
            --http-method=POST \
            --headers="Content-Type=application/json,Authorization=Bearer ${{ secrets.REMINDER_SECRET_TOKEN }}" \
            --description="æ¯åˆ†é˜æª¢æŸ¥ä¸¦ç™¼é€ç”¨è—¥æé†’" \
            --time-zone="Asia/Taipei"
          
          echo "âœ… Cloud Scheduler è¨­ç½®å®Œæˆï¼"
          echo "æ’ç¨‹ä»»å‹™ URL: ${SERVICE_URL}/api/check-reminders"

      # æ­¥é©Ÿ 10: è¼¸å‡ºéƒ¨ç½²çµæœ
      # é¡¯ç¤ºéƒ¨ç½²å®Œæˆå¾Œçš„æœå‹™ URL
      - name: Show deployment result
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "æœå‹™ URL: ${{ steps.deploy.outputs.url }}"
          echo "éƒ¨ç½²çš„æ˜ åƒæª”: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest"
          echo "Commit SHA: ${{ github.sha }}"

      # æ­¥é©Ÿ 11: å¥åº·æª¢æŸ¥ï¼ˆå¯é¸ï¼‰
      # é©—è­‰éƒ¨ç½²çš„æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
      - name: Health check
        run: |
          echo "åŸ·è¡Œå¥åº·æª¢æŸ¥..."
          # ç­‰å¾…æœå‹™å•Ÿå‹•
          sleep 30
          # æª¢æŸ¥æœå‹™æ˜¯å¦å›æ‡‰ï¼ˆæ ¹æ“šæ‚¨çš„æ‡‰ç”¨èª¿æ•´å¥åº·æª¢æŸ¥ç«¯é»ï¼‰
          curl -f ${{ steps.deploy.outputs.url }}/health || echo "å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‡‰ç”¨ç‹€æ…‹"