# GitHub Actions Workflow for deploying to Google Cloud Run
# æ­¤å·¥ä½œæµç¨‹ä½¿ç”¨ Workload Identity Federation é€²è¡Œå®‰å…¨èº«ä»½é©—è­‰
name: Deploy to Cloud Run

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è‡ªå‹•åŸ·è¡Œéƒ¨ç½²
on:
  push:
    branches:
      - main
  # å¯é¸ï¼šæ”¯æ´æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:

# è¨­ç½®ç’°å¢ƒè®Šæ•¸ï¼Œä¾¿æ–¼çµ±ä¸€ç®¡ç†é…ç½®è³‡è¨Š
env:
  PROJECT_ID: gcp1-462701                                  # GCP å°ˆæ¡ˆ ID
  SERVICE_NAME: linebot0831                                # Cloud Run æœå‹™åç¨±
  REGION: us-central1                                      # éƒ¨ç½²å€åŸŸ
  REPOSITORY: linebot-repo                                 # Artifact Registry å€‰åº«åç¨±
  IMAGE_NAME: linebot0831                                  # Docker æ˜ åƒæª”åç¨±

jobs:
  deploy:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu é‹è¡Œç’°å¢ƒ
    runs-on: ubuntu-latest
    
    # é…ç½®æ¬Šé™ï¼Œç¢ºä¿ GITHUB_TOKEN å…·æœ‰å¿…è¦çš„æ¬Šé™
    permissions:
      contents: read
      id-token: write  # é€™å€‹æ¬Šé™å°æ–¼ Workload Identity Federation æ˜¯å¿…éœ€çš„

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡ºç¨‹å¼ç¢¼åº«
      # ç²å–å€‰åº«çš„åŸå§‹ç¢¼åˆ°å·¥ä½œæµé‹è¡Œç’°å¢ƒä¸­
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: é…ç½® Google Cloud èº«ä»½é©—è­‰
      # ä½¿ç”¨æœå‹™å¸³è™Ÿé‡‘é‘°é€²è¡Œèº«ä»½é©—è­‰
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          # æœå‹™å¸³è™Ÿ JSON é‡‘é‘°
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # åŒ¯å‡º Google Cloud SDK æ†‘æ“šä»¥ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          export_environment_variables: true

      # æ­¥é©Ÿ 3: è¨­ç½® Google Cloud SDK
      # å®‰è£ä¸¦é…ç½® gcloud CLI å·¥å…·
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      # æ­¥é©Ÿ 4: é©—è­‰èº«ä»½é©—è­‰ç‹€æ…‹
      # ç¢ºèª gcloud å·²æ­£ç¢ºé…ç½®ä¸¦å¯ä»¥å­˜å– GCP å°ˆæ¡ˆ
      - name: Verify authentication
        run: |
          echo "é©—è­‰ GCP èº«ä»½é©—è­‰ç‹€æ…‹..."
          gcloud auth list
          gcloud config list project

      # æ­¥é©Ÿ 5: é…ç½® Docker èªè­‰
      # é…ç½® Docker ä»¥ä½¿ç”¨ gcloud ä½œç‚º Artifact Registry çš„æ†‘æ“šåŠ©æ‰‹
      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # æ­¥é©Ÿ 6: å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒæª”åˆ° Artifact Registry
      # ä½¿ç”¨å°ˆæ¡ˆä¸­çš„ Dockerfile å»ºç½®æ˜ åƒæª”ä¸¦æ¨é€åˆ° Artifact Registry
      - name: Build and push Docker image
        run: |
          # è¨­ç½®å®Œæ•´çš„æ˜ åƒæª”æ¨™ç±¤
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          
          # å»ºç½® Docker æ˜ åƒæª”ï¼Œä½¿ç”¨ commit SHA å’Œ latest æ¨™ç±¤
          echo "å»ºç½® Docker æ˜ åƒæª”..."
          docker build -t ${IMAGE_TAG}:${{ github.sha }} .
          docker build -t ${IMAGE_TAG}:latest .
          
          # æ¨é€æ˜ åƒæª”åˆ° Artifact Registry
          echo "æ¨é€æ˜ åƒæª”åˆ° Artifact Registry..."
          docker push ${IMAGE_TAG}:${{ github.sha }}
          docker push ${IMAGE_TAG}:latest

      # æ­¥é©Ÿ 7: éƒ¨ç½²åˆ° Cloud Run
      # ä½¿ç”¨å®˜æ–¹çš„ Google GitHub Action éƒ¨ç½²æœå‹™åˆ° Cloud Run
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          # Cloud Run æœå‹™åç¨±
          service: ${{ env.SERVICE_NAME }}
          # éƒ¨ç½²å€åŸŸ
          region: ${{ env.REGION }}
          # è¦éƒ¨ç½²çš„ Docker æ˜ åƒæª”ï¼Œä½¿ç”¨ latest æ¨™ç±¤
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          # è¨­ç½®æœå‹™çš„æ¨™ç±¤ï¼Œä¾¿æ–¼ç®¡ç†å’Œè¿½è¹¤
          labels: |
            environment=production
            deployed-by=github-actions
            commit-sha=${{ github.sha }}
          # ç’°å¢ƒè®Šæ•¸é…ç½® - æ ¹æ“šé‡æ–°è¨­è¨ˆçš„ env.yaml æ–‡ä»¶
          env_vars: |
            ENV=production
            VERSION=${{ github.sha }}
            LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
            LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}
            YOUR_BOT_ID=${{ secrets.YOUR_BOT_ID }}
            LINE_LOGIN_CHANNEL_ID=${{ secrets.LINE_LOGIN_CHANNEL_ID }}
            LINE_LOGIN_CHANNEL_SECRET=${{ secrets.LINE_LOGIN_CHANNEL_SECRET }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            FLASK_ENV=${{ secrets.FLASK_ENV }}
            FLASK_DEBUG=${{ secrets.FLASK_DEBUG }}
            LIFF_CHANNEL_ID=${{ secrets.LIFF_CHANNEL_ID }}
            LIFF_ID_CAMERA=${{ secrets.LIFF_ID_CAMERA }}
            LIFF_ID_EDIT=${{ secrets.LIFF_ID_EDIT }}
            LIFF_ID_PRESCRIPTION_REMINDER=${{ secrets.LIFF_ID_PRESCRIPTION_REMINDER }}
            LIFF_ID_MANUAL_REMINDER=${{ secrets.LIFF_ID_MANUAL_REMINDER }}
            LIFF_ID_HEALTH_FORM=${{ secrets.LIFF_ID_HEALTH_FORM }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GEMINI_MODEL=${{ secrets.GEMINI_MODEL }}
            GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}
            GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
            SPEECH_TO_TEXT_ENABLED=${{ secrets.SPEECH_TO_TEXT_ENABLED }}
            SPEECH_LANGUAGE_CODE=${{ secrets.SPEECH_LANGUAGE_CODE }}
            SPEECH_ENCODING=${{ secrets.SPEECH_ENCODING }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_CHARSET=${{ secrets.DB_CHARSET }}
            DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}
            DB_POOL_TIMEOUT=${{ secrets.DB_POOL_TIMEOUT }}
            REMINDER_SECRET_TOKEN=${{ secrets.REMINDER_SECRET_TOKEN }}
            API_RATE_LIMIT=${{ secrets.API_RATE_LIMIT }}
            SESSION_TIMEOUT=${{ secrets.SESSION_TIMEOUT }}
            VOICE_RECOGNITION_ENABLED=${{ secrets.VOICE_RECOGNITION_ENABLED }}
            AI_ANALYSIS_ENABLED=${{ secrets.AI_ANALYSIS_ENABLED }}
            FAMILY_MANAGEMENT_ENABLED=${{ secrets.FAMILY_MANAGEMENT_ENABLED }}
            HEALTH_MONITORING_ENABLED=${{ secrets.HEALTH_MONITORING_ENABLED }}
            REMINDER_CHECK_INTERVAL=${{ secrets.REMINDER_CHECK_INTERVAL }}
            MAX_REMINDERS_PER_USER=${{ secrets.MAX_REMINDERS_PER_USER }}
            REMINDER_ADVANCE_TIME=${{ secrets.REMINDER_ADVANCE_TIME }}
            AI_RESPONSE_TIMEOUT=${{ secrets.AI_RESPONSE_TIMEOUT }}
            MAX_AI_REQUESTS_PER_HOUR=${{ secrets.MAX_AI_REQUESTS_PER_HOUR }}
            LOG_LEVEL=${{ secrets.LOG_LEVEL }}
            HEALTH_CHECK_ENABLED=${{ secrets.HEALTH_CHECK_ENABLED }}
            METRICS_ENABLED=${{ secrets.METRICS_ENABLED }}
            CACHE_TYPE=${{ secrets.CACHE_TYPE }}
            CACHE_DEFAULT_TIMEOUT=${{ secrets.CACHE_DEFAULT_TIMEOUT }}
            APP_ENV=${{ secrets.APP_ENV }}
            APP_VERSION=${{ secrets.APP_VERSION }}
            APP_NAME=${{ secrets.APP_NAME }}
            PORT=${{ secrets.PORT }}
            HOST=${{ secrets.HOST }}
            WORKERS=${{ secrets.WORKERS }}
            WORKER_TIMEOUT=${{ secrets.WORKER_TIMEOUT }}
            DEBUG_MODE=${{ secrets.DEBUG_MODE }}
            TESTING=${{ secrets.TESTING }}
          # Cloud Run æœå‹™é…ç½®
          cpu: 1              # CPU é…ç½® (1 vCPU)
          memory: 1Gi           # è¨˜æ†¶é«”é…ç½®
          concurrency: 80         # ä¸¦ç™¼è«‹æ±‚æ•¸
          timeout: 300            # è«‹æ±‚é€¾æ™‚æ™‚é–“ï¼ˆç§’ï¼‰
          max_instances: 100      # æœ€å¤§å¯¦ä¾‹æ•¸
          min_instances: 0        # æœ€å°å¯¦ä¾‹æ•¸ï¼ˆ0 è¡¨ç¤ºå¯ä»¥ç¸®æ”¾åˆ°é›¶ï¼‰
          # å…è¨±æœªç¶“èº«ä»½é©—è­‰çš„è«‹æ±‚ï¼ˆæ ¹æ“šæ‚¨çš„å®‰å…¨éœ€æ±‚èª¿æ•´ï¼‰
          flags: --allow-unauthenticated

      # æ­¥é©Ÿ 8: è¼¸å‡ºéƒ¨ç½²çµæœ
      # é¡¯ç¤ºéƒ¨ç½²å®Œæˆå¾Œçš„æœå‹™ URL
      - name: Show deployment result
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "æœå‹™ URL: ${{ steps.deploy.outputs.url }}"
          echo "éƒ¨ç½²çš„æ˜ åƒæª”: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest"
          echo "Commit SHA: ${{ github.sha }}"

      # æ­¥é©Ÿ 9: å¥åº·æª¢æŸ¥ï¼ˆå¯é¸ï¼‰
      # é©—è­‰éƒ¨ç½²çš„æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
      - name: Health check
        run: |
          echo "åŸ·è¡Œå¥åº·æª¢æŸ¥..."
          # ç­‰å¾…æœå‹™å•Ÿå‹•
          sleep 30
          # æª¢æŸ¥æœå‹™æ˜¯å¦å›æ‡‰ï¼ˆæ ¹æ“šæ‚¨çš„æ‡‰ç”¨èª¿æ•´å¥åº·æª¢æŸ¥ç«¯é»ï¼‰
          curl -f ${{ steps.deploy.outputs.url }}/health || echo "å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‡‰ç”¨ç‹€æ…‹"